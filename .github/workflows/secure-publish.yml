name: Conditional Publish

on:
    push:
      tags: ['v*']
  
  jobs:
    publish:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        id-token: write  # Критически важно для OIDC
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
  
        - name: Setup Node.js with OIDC
          uses: actions/setup-node@v4
          with:
            node-version: "18"
            registry-url: 'https://registry.npmjs.org/'
            cache: 'pnpm'
  
        - name: Install pnpm
          run: npm install -g pnpm
  
        - name: Install dependencies
          run: pnpm install
  
        - name: Run tests
          run: pnpm run test
  
        - name: Build
          run: pnpm run build
  
        - name: Verify package content
          run: |
            echo "Package structure:"
            find dist -type f || echo "No dist folder"
            [ -f "package.json" ] && echo "package.json exists" || exit 1
  
        - name: Publish using OIDC
          run: pnpm publish --access public --no-git-checks